# 스레드 안전성

1**. 스레드와 동기화**

* **스레드**는 동시에 여러 작업을 병렬로 처리할 수 있게 해주는 프로그래밍 기법입니다. 자바에서는 **멀티스레딩**을 통해 여러 스레드가 하나의 객체나 데이터를 동시에 접근할 수 있습니다.
* \*\*동기화(synchronization)\*\*는 여러 스레드가 같은 데이터에 접근할 때 **데이터가 손상되거나 잘못된 값이 읽히지 않도록 보호하는 메커니즘**입니다. 동기화 없이 여러 스레드가 동시에 하나의 객체를 수정하면 **경쟁 조건(Race Condition)** 같은 문제가 발생할 수 있습니다.

**2. 메모리 모델**

* 자바는 **메모리 모델**을 통해 **스레드 간의 데이터 가시성**을 정의합니다. 즉, 하나의 스레드에서 만든 객체를 다른 스레드로 넘길 때, 그 객체가 어떻게 다른 스레드에서 **볼 수 있는지**와 **동작할 수 있는지**를 설명하는 것이 메모리 모델입니다.
* 자바 메모리 모델은 각 스레드가 메모리와 어떻게 상호작용하는지, 데이터가 \*\*주 메모리(Main Memory)\*\*에 어떻게 쓰이고 읽히는지를 설명합니다. 예를 들어, **한 스레드가 객체를 만들고 값을 초기화한 후, 그 객체를 다른 스레드로 넘길 때** 다른 스레드가 해당 값을 제대로 읽을 수 있는지의 문제가 여기에 해당합니다.

#### 문제점: 동기화 없이 인스턴스를 다른 스레드로 넘길 때

만약 **동기화 없이** 한 스레드에서 만든 객체를 **다른 스레드로 넘기면**, 다음과 같은 문제가 발생할 수 있습니다:

1. **가시성 문제(Visibility Issue)**:\
   스레드 A에서 객체를 생성하고 필드를 초기화한 후, 그 객체를 스레드 B로 넘길 때, 스레드 B는 스레드 A에서 변경한 값을 **볼 수 없을 수 있습니다**. 이는 자바 메모리 모델에서 **변경된 값이 주 메모리에 바로 기록되지 않기 때문에 발생**합니다. 따라서 스레드 B는 스레드 A가 만든 객체의 **초기 상태나 예상치 못한 값**을 볼 수 있습니다.
2. **명령어 재배열(Reordering)**:\
   자바 컴파일러와 CPU는 최적화를 위해 **명령어 재배열**을 할 수 있습니다. 즉, 객체를 생성하고 초기화하는 순서가 스레드 A에서 스레드 B로 넘어가는 과정에서 변경될 수 있어, **객체가 완전히 초기화되기 전에 다른 스레드에서 그 객체에 접근할 위험**이 있습니다. 이런 경우, 스레드 B는 완전히 초기화되지 않은 객체를 볼 수 있습니다.

#### 해결 방법: 안전한 객체 전달을 위한 방법

자바에서는 동기화 없이도 **안전하게 객체를 다른 스레드로 넘기는 방법**이 있습니다. 다음 방법들이 자주 사용됩니다:

1. **불변 객체(Immutable Object)**:\
   불변 객체는 **한 번 생성되면 절대 상태가 변경되지 않는 객체**입니다. 불변 객체는 **생성 과정 중에 다른 스레드에 노출되더라도 안전**합니다. 왜냐하면 객체의 상태가 변경되지 않기 때문에, 다른 스레드가 그 객체를 읽더라도 안전하게 사용할 수 있기 때문입니다. 자바의 `String`이나 `Integer` 같은 클래스가 그 예입니다.
2. **`final` 필드**:\
   자바에서 **`final` 키워드로 선언된 필드**는 **생성자가 완료된 이후**에 값이 변경되지 않도록 보장합니다. `final` 필드로 선언된 변수는 **스레드 간에 안전하게 공유**될 수 있습니다. 즉, 객체가 다른 스레드에 넘겨졌을 때, `final` 필드 값은 언제나 **정확한 값으로 볼 수 있도록 보장**됩니다.
3. **`volatile` 키워드**:\
   자바에서는 **`volatile` 키워드**를 사용해 **변수를 읽거나 쓸 때 항상 주 메모리와 동기화**되도록 강제할 수 있습니다. `volatile` 변수는 **여러 스레드 간에 동일한 값을 항상 볼 수 있도록 보장**하기 때문에, 동기화 없이 객체를 안전하게 공유할 수 있게 도와줍니다.
4. **스레드 컨텍스트 전환 후 전달**:\
   객체를 **스레드 간에 넘기기 전에 그 객체가 완전히 생성되고 초기화되었음을 보장**하는 방법입니다. 예를 들어, 객체가 생성된 후 스레드를 시작하거나, 객체를 넘기기 전에 **락을 사용하여 동기화**하는 방식으로 안전하게 넘길 수 있습니다.

#### 요약

* 자바의 **메모리 모델**에 따르면, **스레드 간에 객체를 안전하게 공유하기 위해서는** 동기화가 필요합니다. 하지만 **불변 객체**나 **`final` 필드** 또는 **`volatile` 키워드** 같은 기술을 사용하면 **동기화 없이도 안전하게 객체를 다른 스레드로 넘길 수 있습니다**.
* 이러한 개념은 **멀티스레딩 환경에서 데이터 가시성과 일관성**을 보장하는 데 매우 중요합니다. 특히 객체가 완전히 초기화된 후 다른 스레드로 넘기는 것이 중요하며, 이를 보장하지 않으면 **스레드 간의 데이터 손상**이나 **예상치 못한 동작**이 발생할 수 있습니다.
